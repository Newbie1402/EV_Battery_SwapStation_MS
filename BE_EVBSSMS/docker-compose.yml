services:
  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    ports:
      - "8761:8761"
    networks: [evnet]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  kafka:
    image: bitnami/kafka:3.7
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    networks: [evnet]

  zookeeper:
    image: bitnami/zookeeper:3.9
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    ports:
      - "2181:2181"
    networks: [evnet]

  mailhog:
    image: mailhog/mailhog
    ports:
      - "8025:8025"    # UI web
      - "1025:1025"    # SMTP server
    networks: [evnet]

  # ==== API Gateway ====
  gateway:
    container_name: gateway
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    command: ["java", "-jar", "/app/app.jar"]
    ports:
      - "9000:8080"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_SERVER}
    env_file:
      - .env
    depends_on:
      - eureka-server
    networks: [evnet]

  # ==== 5 Service chính ====

  # 1. AUTH-USER SERVICE
  # Chức năng: Đăng ký/đăng nhập, quản lý profile, phương tiện, phân quyền, quản lý nhân viên, xử lý khiếu nại
  auth-user:
    container_name: auth-user-service
    build:
      context: ./auth-user
      dockerfile: Dockerfile
    command: ["java", "-jar", "/app/app.jar"]
    ports:
      - "9001:8080"
    environment:
#      - SERVER_PORT=8080
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${AUTH_USER_DB_HOST}:${AUTH_USER_DB_PORT}/${AUTH_USER_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${AUTH_USER_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${AUTH_USER_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_SERVER}
    env_file:
      - .env
    depends_on:
      - auth-user-db
      - eureka-server
    networks: [evnet]

  auth-user-db:
    image: postgres:16-alpine
    container_name: auth-user-db
    environment:
      - POSTGRES_DB=authdb
      - POSTGRES_USER=ev
      - POSTGRES_PASSWORD=evpass
    ports:
      - "5433:5432"
    volumes:
      - auth-user-data:/var/lib/postgresql/data
    networks: [evnet]

  # 2. STATION SERVICE
  # Chức năng: Quản lý trạm, slot, pin, model, SoH, tìm kiếm trạm gần nhất, geo, routing
  station:
    container_name: station-service
    build:
      context: ./station-inventory
      dockerfile: Dockerfile
    command: ["java", "-jar", "/app/app.jar"]
    ports:
      - "9002:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${STATION_DB_HOST}:${STATION_DB_PORT}/${STATION_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${STATION_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${STATION_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_SERVER}
    env_file:
      - .env
    depends_on:
      - station-db
      - eureka-server
    networks: [evnet]

  station-db:
    image: postgres:16-alpine
    container_name: station-db
    environment:
      - POSTGRES_DB=stationdb
      - POSTGRES_USER=ev
      - POSTGRES_PASSWORD=evpass
    ports:
      - "5434:5432"
    volumes:
      - station-data:/var/lib/postgresql/data
    networks: [evnet]

  # 3. BOOKING SERVICE (gộp booking-swap + support-feedback + notification)
  # Chức năng: Đặt lịch, giữ pin, đổi pin, xử lý giao dịch, support ticket, rating, gửi notification
  booking:
    container_name: booking-service
    build:
      context: ./booking-swap
      dockerfile: Dockerfile
    command: ["java", "-jar", "/app/app.jar"]
    ports:
      - "9003:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${BOOKING_DB_HOST}:${BOOKING_DB_PORT}/${BOOKING_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${BOOKING_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${BOOKING_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_SERVER}
      - SPRING_MAIL_HOST=${MAIL_HOST}
      - SPRING_MAIL_PORT=${MAIL_PORT}
      - SPRING_MAIL_USERNAME=${MAIL_USERNAME}
      - SPRING_MAIL_PASSWORD=${MAIL_PASSWORD}
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    env_file:
      - .env
    depends_on:
      - booking-db
      - eureka-server
      - kafka
      - mailhog
    networks: [evnet]

  booking-db:
    image: postgres:16-alpine
    container_name: booking-db
    environment:
      - POSTGRES_DB=bookingdb
      - POSTGRES_USER=ev
      - POSTGRES_PASSWORD=evpass
    ports:
      - "5435:5432"
    volumes:
      - booking-data:/var/lib/postgresql/data
    networks: [evnet]

  # 4. BILLING SERVICE (gộp billing-payment + analytics)
  # Chức năng: Quản lý thanh toán, hóa đơn, gói thuê, báo cáo, thống kê, AI forecast
  billing:
    container_name: billing-service
    build:
      context: ./billing-payment
      dockerfile: Dockerfile
    command: ["java", "-jar", "/app/app.jar"]
    ports:
      - "9004:8080"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://${BILLING_DB_HOST}:${BILLING_DB_PORT}/${BILLING_DB_NAME}
      - SPRING_DATASOURCE_USERNAME=${BILLING_DB_USER}
      - SPRING_DATASOURCE_PASSWORD=${BILLING_DB_PASSWORD}
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=${EUREKA_SERVER}
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    env_file:
      - .env
    depends_on:
      - billing-db
      - eureka-server
      - kafka
    networks: [evnet]

  billing-db:
    image: postgres:16-alpine
    container_name: billing-db
    environment:
      - POSTGRES_DB=billingdb
      - POSTGRES_USER=ev
      - POSTGRES_PASSWORD=evpass
    ports:
      - "5436:5432"
    volumes:
      - billing-data:/var/lib/postgresql/data
    networks: [evnet]

networks:
  evnet:
    driver: bridge

volumes:
  auth-user-data:
  station-data:
  booking-data:
  billing-data:

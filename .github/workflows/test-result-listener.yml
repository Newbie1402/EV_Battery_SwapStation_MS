# TÃªn cá»§a workflow, sáº½ hiá»ƒn thá»‹ trong tab Actions cá»§a GitHub
name: ğŸ‘‚ Report EV_BSS_MS Test Results

# Trigger: Cháº¡y workflow nÃ y khi nháº­n Ä‘Æ°á»£c sá»± kiá»‡n repository_dispatch
# vá»›i type lÃ  'test-report' do service test runner cá»§a báº¡n gá»­i Ä‘áº¿n.
on:
  repository_dispatch:
    types: [ test-report ]

jobs:
  # TÃªn cá»§a job
  report-status-as-check:
    # Cháº¡y trÃªn mÃ¡y áº£o Ubuntu phiÃªn báº£n má»›i nháº¥t
    runs-on: ubuntu-latest
    
    steps:
      # BÆ°á»›c chÃ­nh: Sá»­ dá»¥ng actions/github-script Ä‘á»ƒ tÆ°Æ¡ng tÃ¡c vá»›i GitHub API
      - name: Create Commit Check Run
        uses: actions/github-script@v7
        with:
          script: |
            // Láº¥y dá»¯ liá»‡u (payload) Ä‘Æ°á»£c gá»­i tá»« service test runner
            const payload = context.payload.client_payload;
            const sha = payload.commitSha;
            
            // Náº¿u khÃ´ng cÃ³ commitSha trong payload, bÃ¡o lá»—i vÃ  dá»«ng láº¡i
            if (!sha) {
              core.setFailed('Missing "commitSha" in the dispatch payload.');
              return;
            }

            // XÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i cuá»‘i cÃ¹ng cá»§a check
            // 'conclusion' cÃ³ thá»ƒ lÃ : success, failure, neutral, cancelled, skipped, timed_out
            const conclusion = payload.status === 'success' ? 'success' : 'failure';

            // Chuáº©n bá»‹ tiÃªu Ä‘á» vÃ  ná»™i dung chi tiáº¿t cho bÃ¡o cÃ¡o
            let summary, details;

            if (conclusion === 'success') {
              summary = `### âœ… EV_BSS_MS Tests Passed`;
              details = `Táº¥t cáº£ cÃ¡c bÃ i test tá»± Ä‘á»™ng trÃªn mÃ´i trÆ°á»ng staging cho commit \`${sha.substring(0, 7)}\` Ä‘Ã£ thÃ nh cÃ´ng.`;
            } else {
              summary = `### âŒ EV_BSS_MS Tests Failed`;
              // Sá»­ dá»¥ng tháº» <details> cá»§a Markdown Ä‘á»ƒ áº©n log lá»—i dÃ i, giÃºp bÃ¡o cÃ¡o gá»n gÃ ng hÆ¡n
              details = `CÃ¡c bÃ i test tá»± Ä‘á»™ng trÃªn mÃ´i trÆ°á»ng staging cho commit \`${sha.substring(0, 7)}\` Ä‘Ã£ tháº¥t báº¡i.

              <details>
                <summary>Nháº¥n Ä‘á»ƒ xem chi tiáº¿t lá»—i</summary>
            
                \`\`\`bash
                ${payload.details}
                \`\`\`
              </details>
              `;
            }
            
            // Sá»­ dá»¥ng Octokit API (Ä‘Æ°á»£c tÃ­ch há»£p sáºµn trong github-script) Ä‘á»ƒ táº¡o má»™t Check Run
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              // TÃªn cá»§a check sáº½ hiá»ƒn thá»‹ bÃªn cáº¡nh commit
              name: 'EV_BSS_MS Staging Tests', 
              // Gáº¯n check nÃ y vÃ o commit SHA cá»¥ thá»ƒ
              head_sha: sha,
              // Tráº¡ng thÃ¡i cá»§a check run, 'completed' vÃ¬ nÃ³ Ä‘Ã£ cháº¡y xong
              status: 'completed',
              conclusion: conclusion,
              // 'output' lÃ  nÆ¡i chá»©a ná»™i dung bÃ¡o cÃ¡o chi tiáº¿t
              output: {
                title: 'EV_BSS_MS Test Results',
                summary: summary,
                text: details
              }
            });

      # BÆ°á»›c cuá»‘i cÃ¹ng: ÄÃ¡nh dáº¥u cáº£ láº§n cháº¡y workflow nÃ y lÃ  'tháº¥t báº¡i' náº¿u test tháº¥t báº¡i.
      # Äiá»u nÃ y ráº¥t quan trá»ng Ä‘á»ƒ branch protection rules hoáº¡t Ä‘á»™ng vÃ  Ä‘á»ƒ nhÃ¬n tháº¥y
      # dáº¥u X mÃ u Ä‘á» trong danh sÃ¡ch cÃ¡c láº§n cháº¡y workflow.
      - name: Fail workflow run if tests failed
        if: ${{ github.event.client_payload.status == 'failure' }}
        run: exit 1